<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Paardenspel – Multiplayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { margin:0; font-family:sans-serif; background:#1e1e1e; color:white; }
    .screen { display:none; padding:20px; }
    .active { display:block; }
    input, button { padding:10px; margin:5px 0; font-size:16px; }
    button { cursor:pointer; }
    #board { display:grid; grid-template-columns: repeat(10,40px); grid-template-rows: repeat(10,40px); gap:2px; margin-top:10px; }
    .cell { width:40px; height:40px; background:#444; display:flex; align-items:center; justify-content:center; font-size:22px; }
    .player { font-weight:bold; }
    .smuggler { color:gold; font-weight:bold; }
  </style>
</head>
<body>

<div id="loginScreen" class="screen active">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="E-mail" />
  <input id="password" type="password" placeholder="Wachtwoord" />
  <button id="loginBtn">Inloggen / Registreren</button>
</div>

<div id="lobbyScreen" class="screen">
  <h2>Lobby</h2>
  <div id="currentUserInfo" style="margin-bottom:10px;"></div>
  <input id="nickname" placeholder="Nickname" />
  <button id="createLobby">Maak lobby</button>
  <button id="restartLobby">(Her)start</button>
  <hr>
  <input id="lobbyCode" placeholder="Lobby code" />
  <button id="joinLobby">Join lobby</button>
</div>

<div id="gameScreen" class="screen">
  <h2 id="gameTitle"></h2>
  <div id="gameInfo" style="margin-bottom:10px;"></div>
  <div id="board"></div>
  <div style="margin-top:10px;">
    <p>Paardensprong invoer (1-9 mini-raster):</p>
    <input id="step1" placeholder="Eerste getal" size="1" /> →
    <input id="step2" placeholder="Tweede getal" size="1" />
    <button id="moveBtn">Spring</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA8LmWdVyebJSYLmKOseg8UFxZege5buMg",
  authDomain: "paardensprong-game.firebaseapp.com",
  projectId: "paardensprong-game",
  storageBucket: "paardensprong-game.appspot.com",
  messagingSenderId: "815440447520",
  appId: "1:815440447520:web:72569450503b4e77b85445",
  measurementId: "G-2CEG2V76FJ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const screens = { login: document.getElementById('loginScreen'), lobby: document.getElementById('lobbyScreen'), game: document.getElementById('gameScreen') };
function show(screen){ Object.values(screens).forEach(s => s.classList.remove('active')); screens[screen].classList.add('active'); }

const loginBtn = document.getElementById('loginBtn');
loginBtn.onclick = () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  if(!email||!password) return alert('Vul e-mail en wachtwoord in');
  auth.signInWithEmailAndPassword(email,password)
    .then(()=>console.log('Ingelogd'))
    .catch(()=>{
      auth.createUserWithEmailAndPassword(email,password)
        .then(()=>console.log('Account aangemaakt en ingelogd'))
        .catch(err=>alert('Fout bij aanmaken account: '+err.message));
    });
};

let currentLobbyId=null,currentPlayerId=null,boardState={players:[],smugglers:[]},nickname='';
const playerColors=['white','red','green','blue'];
const createBtn=document.getElementById('createLobby');
const joinBtn=document.getElementById('joinLobby');
const restartBtn=document.getElementById('restartLobby');
const startPositions = [{x:0,y:0},{x:9,y:0},{x:0,y:9},{x:9,y:9}];

auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById('currentUserInfo').innerText = `Ingelogd als: ${user.email}`;
    currentPlayerId=user.uid;
    const storedLobby = sessionStorage.getItem('currentLobbyId');
    if(storedLobby){
      currentLobbyId=storedLobby;
      listenToLobby(currentLobbyId);
    } else show('lobby');
  } else show('login');
});

async function assignColorAndPosition(lobbyRef){
  const snap = await lobbyRef.collection('players').get();
  const index = snap.size % playerColors.length;
  return { color: playerColors[index], pos: startPositions[index] };
}

createBtn.onclick=async()=>{
  try{
    nickname=document.getElementById('nickname').value.trim();
    if(!nickname) return alert('Vul je nickname in');
    const lobbyRef=db.collection('lobbies').doc();
    currentLobbyId=lobbyRef.id;
    sessionStorage.setItem('currentLobbyId',currentLobbyId);
    await lobbyRef.set({host:currentPlayerId,createdAt:firebase.firestore.FieldValue.serverTimestamp(),status:'waiting'});

    const {color,pos} = await assignColorAndPosition(lobbyRef);
    await lobbyRef.collection('players').doc(currentPlayerId).set({id:currentPlayerId,nickname,x:pos.x,y:pos.y,score:0,color});

    // Plaats 3 smokkelaars
    for(let i=0;i<3;i++){
      let x=Math.floor(Math.random()*10);
      let y=Math.floor(Math.random()*10);
      await lobbyRef.collection('smugglers').doc(`${x}_${y}`).set({x,y});
    }

    alert(`Lobby aangemaakt! Code: ${currentLobbyId}`);
    listenToLobby(currentLobbyId);
  } catch(err){ console.error(err); alert('Fout bij lobby maken: '+err.message); }
};

joinBtn.onclick=async()=>{
  try{
    nickname=document.getElementById('nickname').value.trim();
    const code=document.getElementById('lobbyCode').value.trim();
    if(!nickname||!code) return alert('Vul nickname en lobby code in');
    const lobbyRef=db.collection('lobbies').doc(code);
    const lobbySnap=await lobbyRef.get();
    if(!lobbySnap.exists) return alert('Lobby niet gevonden');

    currentLobbyId=code;
    sessionStorage.setItem('currentLobbyId',currentLobbyId);

    const {color,pos} = await assignColorAndPosition(lobbyRef);
    await lobbyRef.collection('players').doc(currentPlayerId).set({id:currentPlayerId,nickname,x:pos.x,y:pos.y,score:0,color});

    alert(`Je bent joined in lobby: ${code}`);
    listenToLobby(code);
  } catch(err){ console.error(err); alert('Fout bij joinen: '+err.message); }
};

restartBtn.onclick=async()=>{
  if(!currentLobbyId) return alert('Geen actieve lobby');
  const lobbyRef = db.collection('lobbies').doc(currentLobbyId);

  const playersSnap = await lobbyRef.collection('players').get();
  let i = 0;
  const batch = db.batch();
  playersSnap.forEach(doc => {
    const pos = startPositions[i % startPositions.length];
    const color = playerColors[i % playerColors.length];
    batch.update(doc.ref, {x: pos.x, y: pos.y, color, score: 0});
    i++;
  });

  // Verwijder oude smokkelaars
  const smugSnap = await lobbyRef.collection('smugglers').get();
  smugSnap.forEach(doc => batch.delete(doc.ref));

  // Plaats 3 nieuwe smokkelaars
  for(let j=0;j<3;j++){
    let x=Math.floor(Math.random()*10);
    let y=Math.floor(Math.random()*10);
    const docRef = lobbyRef.collection('smugglers').doc(`${x}_${y}`);
    batch.set(docRef, {x, y});
  }

  await batch.commit();
  alert('Spel opnieuw gestart! Posities, kleuren en smokkelaars zijn gereset.');
};

function listenToLobby(lobbyId){
  show('game');
  const playersRef=db.collection('lobbies').doc(lobbyId).collection('players');
  const smugglersRef=db.collection('lobbies').doc(lobbyId).collection('smugglers');

  playersRef.onSnapshot(snapshot=>{
    const players=[];
    snapshot.forEach(doc=>players.push(doc.data()));
    boardState.players = players;
    renderBoard(boardState.players, boardState.smugglers);
    updateGameInfo(players);
  });

  smugglersRef.onSnapshot(snapshot=>{
    const smugglers=[];
    snapshot.forEach(doc=>smugglers.push(doc.data()));
    boardState.smugglers = smugglers;
    renderBoard(boardState.players, boardState.smugglers);
  });
}

function renderBoard(players,smugglers){
  const board=document.getElementById('board'); board.innerHTML='';
  for(let y=0;y<10;y++){
    for(let x=0;x<10;x++){
      const cell=document.createElement('div'); cell.className='cell';
      const playerHere=players.find(p=>p.x===x && p.y===y);
      if(playerHere){ const span=document.createElement('span'); span.className='player'; span.style.color=playerHere.color; span.textContent='♞'; cell.appendChild(span); }
      else if(smugglers.find(s=>s.x===x && s.y===y)){ const span=document.createElement('span'); span.className='smuggler'; span.textContent='♟'; cell.appendChild(span); }
      board.appendChild(cell);
    }
  }
}

function updateGameInfo(players){
  const me=players.find(p=>p.id===currentPlayerId);
  const infoDiv=document.getElementById('gameInfo');
  infoDiv.innerHTML=`<strong>Lobby:</strong> ${currentLobbyId} <br><strong>Jij:</strong> ${me?me.nickname:'Onbekend'} <br><strong>Spelers:</strong> ${players.map(p=>p.nickname).join(', ')}`;
}

const moveBtn=document.getElementById('moveBtn');
moveBtn.onclick=async()=>{
  const a=parseInt(document.getElementById('step1').value);
  const b=parseInt(document.getElementById('step2').value);
  if(!a||!b||a<1||a>9||b<1||b>9) return alert('Voer getallen 1-9 in');
  const dx=getDeltaX(a,b); const dy=getDeltaY(a,b);
  let player=boardState.players.find(p=>p.id===currentPlayerId); if(!player) return;
  let newX=Math.max(0,Math.min(9,player.x+dx)); let newY=Math.max(0,Math.min(9,player.y+dy));
  const playerRef=db.collection('lobbies').doc(currentLobbyId).collection('players').doc(currentPlayerId);
  const smug=boardState.smugglers.find(s=>s.x===newX && s.y===newY);
  if(smug){ await db.collection('lobbies').doc(currentLobbyId).collection('smugglers').doc(`${smug.x}_${smug.y}`).delete(); player.score+=1; alert('Je hebt een smokkelaar gevangen! Score: '+player.score); }
  await playerRef.update({x:newX,y:newY,score:player.score});
};

function getDeltaX(a,b){ const coords={1:[0,0],2:[1,0],3:[2,0],4:[0,1],5:[1,1],6:[2,1],7:[0,2],8:[1,2],9:[2,2]}; return coords[b][0]-coords[a][0]; }
function getDeltaY(a,b){ const coords={1:[0,0],2:[1,0],3:[2,0],4:[0,1],5:[1,1],6:[2,1],7:[0,2],8:[1,2],9:[2,2]}; return coords[b][1]-coords[a][1]; }

</script>
</body>
</html>
