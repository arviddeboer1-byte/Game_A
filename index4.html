<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Paardenspel – Multiplayer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { margin:0; font-family:sans-serif; background:#1e1e1e; color:white; }
.screen { display:none; padding:20px; }
.active { display:block; }
input, button { padding:10px; margin:5px 0; font-size:16px; }
button { cursor:pointer; }
#board { display:grid; grid-template-columns: repeat(10,40px); grid-template-rows: repeat(10,40px); gap:2px; margin-top:10px; }
.cell { width:40px; height:40px; background:#444; display:flex; align-items:center; justify-content:center; font-size:22px; position:relative; }
.player { font-weight:bold; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: transform 0.2s; }
.player.glow { box-shadow: 0 0 10px 3px lime; border-radius:50%; }
.player span.name { font-size:10px; display:block; text-align:center; margin-top:2px; }
.smuggler { color:gold; font-weight:bold; }
#miniRaster { display:grid; grid-template-columns: repeat(3,40px); grid-template-rows: repeat(3,40px); gap:2px; margin-top:10px; }
#miniRaster .cell { cursor:pointer; display:flex; align-items:center; justify-content:center; background:#333; color:white; font-weight:bold; }
#miniRaster .cell.active { background:green; }
#miniRaster .cell.valid { background:lightblue; }
</style>
</head>
<body>

<div id="loginScreen" class="screen active">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="E-mail" />
  <input id="password" type="password" placeholder="Wachtwoord" />
  <button id="loginBtn">Inloggen / Registreren</button>
</div>

<div id="lobbyScreen" class="screen">
  <h2>Lobby</h2>
  <div id="currentUserInfo" style="margin-bottom:10px;"></div>
  <input id="nickname" placeholder="Nickname" />
  <button id="createLobby">Maak lobby</button>
  <hr>
  <input id="lobbyCode" placeholder="Lobby code" />
  <button id="joinLobby">Join lobby</button>
  <hr>
  <button id="logoutBtnLobby">Uitloggen</button>
</div>

<div id="gameScreen" class="screen">
  <h2 id="gameTitle"></h2>
  <div id="gameInfo" style="margin-bottom:10px;"></div>
  <button id="restartBtn">Herstart</button>
  <button id="leaveLobbyBtn">Verlaat lobby</button>
  <button id="logoutBtnGame">Uitloggen</button>
  <div id="board"></div>
  <div>
    <p>Mini-raster (klik op 1 vlak per beurt, start op 5):</p>
    <div id="miniRaster"></div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyA8LmWdVyebJSYLmKOseg8UFxZege5buMg",
    authDomain: "paardensprong-game.firebaseapp.com",
    projectId: "paardensprong-game",
    storageBucket: "paardensprong-game.appspot.com",
    messagingSenderId: "815440447520",
    appId: "1:815440447520:web:72569450503b4e77b85445",
    measurementId: "G-2CEG2V76FJ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const screens = { login: document.getElementById('loginScreen'), lobby: document.getElementById('lobbyScreen'), game: document.getElementById('gameScreen') };
  function show(screen){ Object.values(screens).forEach(s => s.classList.remove('active')); screens[screen].classList.add('active'); }

  let currentLobbyId=sessionStorage.getItem('currentLobbyId')||null;
  let currentPlayerId=null;
  let boardState={players:[],smugglers:[]};
  let nickname='';
  const playerColors=['white','red','green','blue'];
  const startPositions = [{x:0,y:0},{x:9,y:0},{x:0,y:9},{x:9,y:9}];

  const loginBtn = document.getElementById('loginBtn');
  const createBtn=document.getElementById('createLobby');
  const joinBtn=document.getElementById('joinLobby');
  const restartBtn=document.getElementById('restartBtn');
  const leaveLobbyBtn=document.getElementById('leaveLobbyBtn');
  const logoutBtnLobby=document.getElementById('logoutBtnLobby');
  const logoutBtnGame=document.getElementById('logoutBtnGame');

  loginBtn.onclick = () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if(!email||!password) return alert('Vul e-mail en wachtwoord in');
    auth.signInWithEmailAndPassword(email,password)
      .then(()=>console.log('Ingelogd'))
      .catch(()=>{
        auth.createUserWithEmailAndPassword(email,password)
          .then(()=>console.log('Account aangemaakt en ingelogd'))
          .catch(err=>alert('Fout bij aanmaken account: '+err.message));
      });
  };

  async function assignColorAndPosition(lobbyRef){
    const snap = await lobbyRef.collection('players').get();
    const index = snap.size % playerColors.length;
    return { color: playerColors[index], pos: startPositions[index] };
  }

  createBtn.onclick=async()=>{
    try{
      nickname=document.getElementById('nickname').value.trim();
      if(!nickname) return alert('Vul je nickname in');
      const lobbyRef=db.collection('lobbies').doc();
      currentLobbyId=lobbyRef.id;
      sessionStorage.setItem('currentLobbyId',currentLobbyId);
      await lobbyRef.set({host:currentPlayerId,createdAt:firebase.firestore.FieldValue.serverTimestamp(),status:'waiting'});

      const {color,pos} = await assignColorAndPosition(lobbyRef);
      await lobbyRef.collection('players').doc(currentPlayerId).set({id:currentPlayerId,nickname,x:pos.x,y:pos.y,score:0,color});

      await createSmugglers(lobbyRef);
      alert(`Lobby aangemaakt! Code: ${currentLobbyId}`);
      listenToLobby(currentLobbyId);
    } catch(err){ console.error(err); alert('Fout bij lobby maken: '+err.message); }
  };

  joinBtn.onclick=async()=>{
    try{
      nickname=document.getElementById('nickname').value.trim();
      const code=document.getElementById('lobbyCode').value.trim();
      if(!nickname||!code) return alert('Vul nickname en lobby code in');
      const lobbyRef=db.collection('lobbies').doc(code);
      const lobbySnap=await lobbyRef.get();
      if(!lobbySnap.exists) return alert('Lobby niet gevonden');

      currentLobbyId=code;
      sessionStorage.setItem('currentLobbyId',currentLobbyId);

      const {color,pos} = await assignColorAndPosition(lobbyRef);
      await lobbyRef.collection('players').doc(currentPlayerId).set({id:currentPlayerId,nickname,x:pos.x,y:pos.y,score:0,color});
      listenToLobby(code);
    } catch(err){ console.error(err); alert('Fout bij joinen: '+err.message); }
  };

  restartBtn.onclick=async()=>{
    if(!currentLobbyId) return alert('Geen actieve lobby');
    const lobbyRef = db.collection('lobbies').doc(currentLobbyId);

    const playersSnap = await lobbyRef.collection('players').get();
    const batch = db.batch();
    let i = 0;
    const usedPositions = [];
    playersSnap.forEach(doc => {
      const pos = startPositions[i % startPositions.length];
      const color = playerColors[i % playerColors.length];
      usedPositions.push(pos);
      batch.update(doc.ref, { x: pos.x, y: pos.y, color, score: 0 });
      i++;
    });

    const smugSnap = await lobbyRef.collection('smugglers').get();
    smugSnap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    await createSmugglers(lobbyRef, usedPositions);
  };

  leaveLobbyBtn.onclick = async () => {
    if(!currentLobbyId) return;
    const lobbyRef = db.collection('lobbies').doc(currentLobbyId);
    await lobbyRef.collection('players').doc(currentPlayerId).delete();
    currentLobbyId = null;
    sessionStorage.removeItem('currentLobbyId');
    show('lobby');
  };

  logoutBtnLobby.onclick = () => auth.signOut();
  logoutBtnGame.onclick = () => auth.signOut();

  async function createSmugglers(lobbyRef, usedPositions=[]){
    let j=0;
    while(j<3){
      let x=Math.floor(Math.random()*10);
      let y=Math.floor(Math.random()*10);
      if(!usedPositions.find(p=>p.x===x && p.y===y)){
        await lobbyRef.collection('smugglers').doc(`${x}_${y}`).set({x,y});
        j++;
      }
    }
  }

  auth.onAuthStateChanged(user => {
    if(user){
      currentPlayerId=user.uid;
      document.getElementById('currentUserInfo').innerText = `Ingelogd als: ${user.email}`;
      if(currentLobbyId){
        listenToLobby(currentLobbyId);
      } else show('lobby');
    } else show('login');
  });

  function listenToLobby(lobbyId){
    show('game');
    const playersRef=db.collection('lobbies').doc(lobbyId).collection('players');
    const smugglersRef=db.collection('lobbies').doc(lobbyId).collection('smugglers');

    playersRef.onSnapshot(snapshot=>{
      const players=[];
      snapshot.forEach(doc=>players.push(doc.data()));
      boardState.players = players;
      renderBoard(boardState.players, boardState.smugglers);
      updateGameInfo(players);
    });

    smugglersRef.onSnapshot(snapshot=>{
      const smugglers=[];
      snapshot.forEach(doc=>smugglers.push(doc.data()));
      boardState.smugglers = smugglers;
      renderBoard(boardState.players, boardState.smugglers);
    });
  }

  function renderBoard(players,smugglers){
    const board=document.getElementById('board'); board.innerHTML='';
    for(let y=0;y<10;y++){
      for(let x=0;x<10;x++){
        const cell=document.createElement('div'); cell.className='cell';
        const playerHere=players.find(p=>p.x===x && p.y===y);
        if(playerHere){
          const span=document.createElement('div'); span.className='player';
          span.style.color=playerHere.color;
          span.innerHTML='♞<span class="name">'+playerHere.nickname+' ('+playerHere.score+')</span>';
          if(playerHere.id===currentPlayerId) span.classList.add('glow');
          cell.appendChild(span);
        } else if(smugglers.find(s=>s.x===x && s.y===y)){
          const span=document.createElement('span'); span.className='smuggler';
          span.textContent='♟';
          cell.appendChild(span);
        }
        board.appendChild(cell);
      }
    }
  }

  function updateGameInfo(players){
    const me=players.find(p=>p.id===currentPlayerId);
    const infoDiv=document.getElementById('gameInfo');
    infoDiv.innerHTML=`<strong>Lobby:</strong> ${currentLobbyId} <br><strong>Jij:</strong> ${me?me.nickname:'Onbekend'} <br><strong>Spelers:</strong> ${players.map(p=>p.nickname).join(', ')}`;
  }

  // ---- Mini-raster logica ----
  const miniRaster=document.getElementById('miniRaster');
  let cursorPos=5; // start in midden
  const coords={1:[0,0],2:[1,0],3:[2,0],4:[0,1],5:[1,1],6:[2,1],7:[0,2],8:[1,2],9:[2,2]};
  function drawMiniRaster(){
    miniRaster.innerHTML='';
    for(let i=1;i<=9;i++){
      const cell=document.createElement('div'); cell.className='cell';
      cell.textContent=i;
      if(i===cursorPos) cell.classList.add('active');
      const validNext = getValidFromCursor(i);
      if(validNext) cell.classList.add('valid');
      cell.onclick=()=>{ handleMiniClick(i); };
      miniRaster.appendChild(cell);
    }
  }
  function handleMiniClick(i){
    if(i===cursorPos) return;
    const dx=coords[i][0]-coords[cursorPos][0];
    const dy=coords[i][1]-coords[cursorPos][1];
    if((Math.abs(dx)===2 && Math.abs(dy)===1)||(Math.abs(dx)===1 && Math.abs(dy)===2)){
      movePlayer(dx,dy);
    }
    cursorPos=i;
    drawMiniRaster();
  }
  function getValidFromCursor(i){
    const dx=coords[i][0]-coords[cursorPos][0];
    const dy=coords[i][1]-coords[cursorPos][1];
    return (Math.abs(dx)===2 && Math.abs(dy)===1)||(Math.abs(dx)===1 && Math.abs(dy)===2);
  }

  function movePlayer(dx,dy){
    let player=boardState.players.find(p=>p.id===currentPlayerId);
    if(!player) return;
    let newX=Math.max(0,Math.min(9,player.x+dx));
    let newY=Math.max(0,Math.min(9,player.y+dy));
    const playerRef=db.collection('lobbies').doc(currentLobbyId).collection('players').doc(currentPlayerId);
    const smug=boardState.smugglers.find(s=>s.x===newX && s.y===newY);
    if(smug){ db.collection('lobbies').doc(currentLobbyId).collection('smugglers').doc(`${smug.x}_${smug.y}`).delete(); player.score+=1; alert('Je hebt een smokkelaar gevangen! Score: '+player.score); }
    playerRef.update({x:newX,y:newY,score:player.score});
  }

  drawMiniRaster();
});
</script>

</body>
</html>
